<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库 - 微纳科技</title>
    
    <!-- CSS -->
    <link href="../assets/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="../assets/vendor/animate.css/animate.min.css" rel="stylesheet">
    <link href="../assets/css/styles.css" rel="stylesheet">
    
    <!-- 添加网站图标 -->
    <link rel="icon" type="image/png" href="../images/logo.png">
    
    <style>
        .knowledge-page { padding-top: 100px !important; }
        .file-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-1px);
            border-color: #007bff;
        }
        .file-icon {
            font-size: 2rem;
            color: #007bff;
            width: 2.5rem;
            text-align: center;
        }
        .search-box {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .folder-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .folder-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }
        .folder-header:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
            margin: -0.5rem -0.5rem 0.5rem -0.5rem;
        }
        .folder-toggle {
            transition: transform 0.3s ease;
        }
        .folder-content {
            transition: all 0.3s ease;
        }
        .btn-copy {
            margin-left: 0.5rem;
        }
        .copy-success {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }
        
        /* 文件项优化 */
        .file-item .btn {
            white-space: nowrap;
        }
        .file-item h6 {
            font-weight: 600;
            color: #2c3e50;
        }
        .file-item .text-muted {
            font-size: 0.875rem;
        }
        .min-w-0 {
            min-width: 0;
        }
        
        /* 左侧导航样式 */
        .sidebar-nav {
            position: sticky;
            top: 120px;
            z-index: 100;
        }
        
        .sidebar-nav .card {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: none;
            border-radius: 10px;
        }
        
        .sidebar-nav .list-group-item {
            border: none;
            border-radius: 0;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .sidebar-nav .list-group-item:hover {
            background-color: #f8f9fa;
            border-left-color: #007bff;
        }
        
        .sidebar-nav .list-group-item.active {
            background-color: #e3f2fd;
            border-left-color: #007bff;
            color: #007bff;
        }
        
        .sidebar-nav .folder-count {
            background-color: #007bff;
            color: white;
            border-radius: 12px;
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            margin-left: auto;
        }
        
        .sidebar-nav .folder-name {
            font-weight: 500;
        }
        
        /* 响应式调整 */
        @media (max-width: 991.98px) {
            .sidebar-nav {
                position: static;
                margin-bottom: 2rem;
            }
        }
        
        /* 加载动画优化 */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* 按钮组优化 */
        .btn-group-sm > .btn, .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* 图标按钮样式 */
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .btn-icon i {
            font-size: 1rem;
        }
        
        /* 文件操作按钮容器 */
        .file-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        /* 模式切换按钮样式 */
        .btn-outline-primary.active,
        .btn-outline-danger.active {
            color: white;
        }
        
        .btn-outline-primary.active {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .btn-outline-danger.active {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        /* 模态框优化 */
        .modal-dialog {
            max-width: 500px;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../images/logo.png" alt="微纳科技" height="40" onerror="this.src='https://via.placeholder.com/120x40?text=微纳科技'">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            服务
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="servers/nanoimprint-server.html">纳米压印</a></li>
                            <li><a class="dropdown-item" href="servers/etching-server.html">微纳刻蚀</a></li>
                            <li><a class="dropdown-item" href="servers/metamaterial-server.html">超材料产品</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            技术知识
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="knowledge/nanoimprint-knowledge.html">纳米压印技术</a></li>
                            <li><a class="dropdown-item" href="knowledge/etching-knowledge.html">微纳刻蚀技术</a></li>
                            <li><a class="dropdown-item" href="knowledge/metamaterial-knowledge.html">超材料技术</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="knowledge-base.html">知识库</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cases.html">案例</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">关于我们</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">联系我们</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 页面内容 -->
    <main class="knowledge-page">
        <div class="container-fluid py-5">
            <div class="row">
                <!-- 左侧导航 -->
                <div class="col-lg-3">
                    <div class="sidebar-nav">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-folder me-2"></i>文件夹导航</h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="folderNav" class="list-group list-group-flush">
                                    <!-- 文件夹导航将通过JavaScript动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 主要内容区域 -->
                <div class="col-lg-9">
                    <div class="row">
                        <div class="col-12">
                            <h1 class="mb-4 text-center">知识库</h1>
                            <p class="text-muted text-center mb-5">浏览和下载技术文档、资料和文件</p>
                        </div>
                    </div>

                    <!-- 搜索框 -->
                    <div class="search-box">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="搜索文件名...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="refreshFileList()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>刷新列表
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="showManageModal()">
                                    <i class="bi bi-gear me-2"></i>管理文件
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 文件列表 -->
                    <div id="fileList">
                        <!-- 文件列表将通过JavaScript动态加载 -->
                    </div>

                    <!-- 加载提示 -->
                    <div id="loadingIndicator" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在扫描文件...</p>
                    </div>

                    <!-- 无文件提示 -->
                    <div id="noFilesMessage" class="text-center py-5" style="display: none;">
                        <i class="bi bi-folder-x text-muted" style="font-size: 3rem;"></i>
                        <h4 class="mt-3 text-muted">暂无文件</h4>
                        <p class="text-muted">请检查 knowledgehub 文件夹是否包含文件</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 文件管理模态框 -->
    <div class="modal fade" id="manageModal" tabindex="-1" aria-labelledby="manageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="manageModalLabel">
                        <i class="bi bi-gear me-2"></i>文件管理
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 模式切换按钮 -->
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-primary flex-fill" id="uploadModeBtn" onclick="switchToUploadMode()">
                            <i class="bi bi-cloud-upload me-2"></i>上传文件
                        </button>
                        <button class="btn btn-outline-danger flex-fill" id="deleteModeBtn" onclick="switchToDeleteMode()">
                            <i class="bi bi-trash me-2"></i>删除文件
                        </button>
                    </div>
                    
                    <!-- 上传文件内容 -->
                    <div id="uploadContent">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="uploadPassword" class="form-label">上传密码</label>
                                <input type="password" class="form-control" id="uploadPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="uploadDirectory" class="form-label">存放目录</label>
                                <select class="form-select" id="uploadDirectory" required>
                                    <option value="">请选择目录</option>
                                    <option value="auto">自动创建（按当前月份）</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="uploadFile" class="form-label">选择文件</label>
                                <input type="file" class="form-control" id="uploadFile" required multiple>
                            </div>
                            <div class="mb-3">
                                <div id="uploadProgress" class="progress" style="display: none;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="uploadStatus"></div>
                        </form>
                    </div>
                    
                    <!-- 删除文件内容 -->
                    <div id="deleteContent" style="display: none;">
                        <div class="mb-3">
                            <label for="deletePassword" class="form-label">删除密码</label>
                            <input type="password" class="form-control" id="deletePassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="deleteFileSelect" class="form-label">选择要删除的文件</label>
                            <select class="form-select" id="deleteFileSelect" required>
                                <option value="">请选择文件</option>
                            </select>
                        </div>
                        <div id="deleteStatus"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="manageActionBtn">
                        <i class="bi bi-upload me-2"></i>上传文件
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-light py-4 mt-5">
        <style>
            .qr-code-wrapper img {
                width: 150px;
                height: 150px;
                object-fit: contain;
                transition: transform 0.3s ease;
            }
            .qr-code-wrapper img:hover {
                transform: scale(1.2);
            }
            .footer-divider {
                margin: 1rem 0;
                opacity: 0.2;
            }
        </style>
        <div class="container">
            <div class="row g-4 justify-content-center">
                <div class="col-lg-3">
                    <h5 class="mb-3 text-center">关于我们</h5>
                    <p class="small text-start">微纳科技专注于微纳加工技术的研发与应用，为客户提供高品质的微纳加工解决方案。</p>
                </div>
                <div class="col-lg-3">
                    <h5 class="mb-3 text-center">联系方式</h5>
                    <ul class="list-unstyled small text-start">
                        <li class="mb-2"><i class="bi bi-geo-alt me-2"></i>上海市松江区泗泾镇泗通路 246 号</li>
                        <li class="mb-2"><i class="bi bi-telephone me-2"></i>+86 18701960619</li>
                        <li class="mb-2"><i class="bi bi-envelope me-2"></i>service@oplasmon.com</li>
                    </ul>
                </div>
                <div class="col-lg-3">
                    <h5 class="mb-3 text-center">快速链接</h5>
                    <ul class="list-unstyled small text-start">
                        <li class="mb-2"><a href="servers/nanoimprint-server.html" class="text-light text-decoration-none">纳米压印服务</a></li>
                        <li class="mb-2"><a href="servers/etching-server.html" class="text-light text-decoration-none">微纳刻蚀服务</a></li>
                        <li class="mb-2"><a href="servers/metamaterial-server.html" class="text-light text-decoration-none">超材料产品</a></li>
                    </ul>
                </div>
                <div class="col-lg-3">
                    <h5 class="mb-3 text-center">关注我们</h5>
                    <div class="d-flex justify-content-center gap-4">
                        <div class="qr-code-wrapper">
                            <img src="../images/qrcode-weixin.jpg" alt="微信公众号">
                        </div>
                        <div class="qr-code-wrapper">
                            <img src="../images/qrcode-douyin.jpg" alt="抖音号">
                        </div>
                    </div>
                </div>
            </div>
            <hr class="footer-divider">
            <div class="text-center">
                <p class="copyright small mb-0">&copy; 2024 微纳科技. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="../assets/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../assets/js/scripts.js"></script>
    
    <script>
        // 导航栏滚动效果
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // 文件列表数据
        let allFiles = [];
        let filteredFiles = [];

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadFileList();
            setupEventListeners();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 搜索功能
            document.getElementById('searchInput').addEventListener('input', function() {
                filterFiles(this.value);
            });
            
            // 刷新按钮点击事件
            document.querySelector('.btn-outline-secondary').addEventListener('click', refreshFileList);
            
            // 上传按钮点击事件
            document.querySelector('.btn-primary').addEventListener('click', showManageModal);
            
            // 滚动监听，自动高亮当前可见的文件夹
            window.addEventListener('scroll', function() {
                highlightVisibleFolder();
            });
            
            // 模态框关闭事件监听
            const modalElement = document.getElementById('manageModal');
            modalElement.addEventListener('hidden.bs.modal', function () {
                // 模态框关闭后清理状态
                document.getElementById('uploadForm').reset();
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadStatus').innerHTML = '';
                switchToUploadMode(); // 切换回上传模式
            });
            
            // 模态框关闭按钮事件
            const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 确保模态框完全关闭
                    setTimeout(() => {
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 100);
                });
            });
        }

        // 高亮当前可见的文件夹
        function highlightVisibleFolder() {
            const folderSections = document.querySelectorAll('.folder-section');
            const navItems = document.querySelectorAll('#folderNav .list-group-item');
            
            // 移除所有活动状态
            navItems.forEach(item => item.classList.remove('active'));
            
            // 找到当前可见的文件夹
            let currentFolder = null;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            
            folderSections.forEach(section => {
                const rect = section.getBoundingClientRect();
                const sectionTop = rect.top + scrollTop;
                const sectionBottom = sectionTop + rect.height;
                
                // 如果文件夹在视窗中可见
                if (sectionTop <= scrollTop + windowHeight * 0.3 && sectionBottom >= scrollTop + windowHeight * 0.3) {
                    const folderId = section.id.replace('folder-', '');
                    currentFolder = folderId;
                }
            });
            
            // 高亮当前文件夹
            if (currentFolder) {
                const navItem = document.querySelector(`#folderNav .list-group-item[onclick*="${currentFolder}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
        }

        // 刷新文件列表
        function refreshFileList() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('noFilesMessage').style.display = 'none';
            document.getElementById('fileList').innerHTML = '';
            
            // 添加短暂延迟确保服务器有足够时间处理文件
            setTimeout(() => {
                loadFileList();
            }, 500);
        }

        // 紧急修复模态框卡住的问题
        function forceCloseModal() {
            const modalElement = document.getElementById('manageModal');
            const backdrop = document.querySelector('.modal-backdrop');
            
            // 移除遮罩层
            if (backdrop) {
                backdrop.remove();
            }
            
            // 重置模态框状态
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            
            // 重置body状态
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // 清理表单
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadStatus').innerHTML = '';
            
            console.log('模态框已强制关闭');
        }

        // 显示管理模态框
        function showManageModal() {
            // 更新目录选项
            updateDirectoryOptions();
            // 更新删除文件选项
            updateDeleteFileOptions();
            
            // 确保之前的模态框完全关闭
            forceCloseModal();
            
            const modal = new bootstrap.Modal(document.getElementById('manageModal'));
            modal.show();
            
            // 默认显示上传模式
            switchToUploadMode();
        }

        // 切换到上传模式
        function switchToUploadMode() {
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('deleteContent').style.display = 'none';
            document.getElementById('uploadModeBtn').classList.add('active');
            document.getElementById('deleteModeBtn').classList.remove('active');
            document.getElementById('manageActionBtn').innerHTML = '<i class="bi bi-upload me-2"></i>上传文件';
            document.getElementById('manageActionBtn').onclick = handleFileUpload;
        }

        // 切换到删除模式
        function switchToDeleteMode() {
            document.getElementById('uploadContent').style.display = 'none';
            document.getElementById('deleteContent').style.display = 'block';
            document.getElementById('uploadModeBtn').classList.remove('active');
            document.getElementById('deleteModeBtn').classList.add('active');
            document.getElementById('manageActionBtn').innerHTML = '<i class="bi bi-trash me-2"></i>删除文件';
            document.getElementById('manageActionBtn').onclick = handleFileDelete;
        }

        // 更新目录选项
        function updateDirectoryOptions() {
            const select = document.getElementById('uploadDirectory');
            const currentValue = select.value;
            
            // 清空现有选项（保留前两个）
            while (select.children.length > 2) {
                select.removeChild(select.lastChild);
            }
            
            // 添加现有目录选项
            const existingFolders = [...new Set(allFiles.map(file => file.path))];
            existingFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder;
                option.textContent = folder;
                select.appendChild(option);
            });
            
            // 恢复选择的值
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // 更新删除文件选项
        function updateDeleteFileOptions() {
            const select = document.getElementById('deleteFileSelect');
            const currentValue = select.value;
            
            // 清空现有选项（保留第一个）
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // 添加文件选项
            allFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file.id;
                option.textContent = `${file.path}/${file.name} (${formatFileSize(file.size)})`;
                select.appendChild(option);
            });
            
            // 恢复选择的值
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // 处理文件上传
        async function handleFileUpload() {
            const password = document.getElementById('uploadPassword').value;
            const directory = document.getElementById('uploadDirectory').value;
            const fileInput = document.getElementById('uploadFile');
            
            // 验证密码
            if (password !== 'fjfjfjfj') {
                showUploadStatus('密码错误，请重新输入', 'danger');
                return;
            }
            
            // 验证目录选择
            if (!directory) {
                showUploadStatus('请选择存放目录', 'danger');
                return;
            }
            
            // 验证文件选择
            if (!fileInput.files || fileInput.files.length === 0) {
                showUploadStatus('请选择要上传的文件', 'danger');
                return;
            }
            
            // 确定目标目录
            let targetDirectory = directory;
            if (directory === 'auto') {
                const now = new Date();
                targetDirectory = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }
            
            // 显示上传进度
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '准备上传...';
            
            try {
                const files = Array.from(fileInput.files);
                let uploadedCount = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 更新进度
                    const progress = Math.round(((i + 1) / files.length) * 100);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = `上传中... ${i + 1}/${files.length}`;
                    
                    // 上传文件
                    await uploadSingleFile(file, targetDirectory);
                    uploadedCount++;
                }
                
                // 上传完成
                progressBar.style.width = '100%';
                progressBar.textContent = '上传完成！';
                showUploadStatus(`成功上传 ${uploadedCount} 个文件到 ${targetDirectory} 目录`, 'success');
                
                // 清空表单
                document.getElementById('uploadForm').reset();
                
                // 立即刷新文件列表并关闭模态框
                setTimeout(() => {
                    // 先刷新文件列表
                    refreshFileList();
                    
                    // 然后关闭模态框
                    const modalElement = document.getElementById('manageModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    } else {
                        // 如果无法获取模态框实例，手动移除遮罩层
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }
                    
                    // 隐藏进度条
                    progressDiv.style.display = 'none';
                }, 1000); // 减少等待时间到1秒
                
            } catch (error) {
                console.error('上传错误:', error);
                showUploadStatus('上传失败: ' + error.message, 'danger');
                progressDiv.style.display = 'none';
            }
        }

        // 上传单个文件
        async function uploadSingleFile(file, directory) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('directory', directory);
            formData.append('password', 'fjfjfjfj');
            
            // 根据当前页面URL确定API地址
            const currentHost = window.location.hostname;
            const apiUrl = currentHost === 'localhost' || currentHost === '127.0.0.1' 
                ? 'http://localhost:8000/api/upload'
                : `http://${currentHost}:8000/api/upload`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || '上传失败');
            }
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || '上传失败');
            }
        }

        // 显示上传状态
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // 处理文件删除
        async function handleFileDelete() {
            const password = document.getElementById('deletePassword').value;
            const fileId = document.getElementById('deleteFileSelect').value;
            
            console.log('开始删除文件，fileId:', fileId, 'password:', password ? '***' : 'undefined');
            
            // 验证密码
            if (password !== 'fjfjfjfj') {
                console.log('密码验证失败');
                showDeleteStatus('密码错误，请重新输入', 'danger');
                return;
            }
            
            // 验证文件选择
            if (!fileId) {
                console.log('未选择文件');
                showDeleteStatus('请选择要删除的文件', 'danger');
                return;
            }
            
            // 确认删除
            const file = allFiles.find(f => f.id === fileId);
            console.log('找到要删除的文件:', file);
            
            if (!file) {
                console.log('在文件列表中未找到文件');
                showDeleteStatus('文件不存在', 'danger');
                return;
            }
            
            if (!confirm(`确定要删除文件 "${file.name}" 吗？此操作不可恢复。`)) {
                console.log('用户取消删除');
                return;
            }
            
            try {
                // 根据当前页面URL确定API地址
                const currentHost = window.location.hostname;
                const apiUrl = currentHost === 'localhost' || currentHost === '127.0.0.1' 
                    ? 'http://localhost:8000/api/delete'
                    : `http://${currentHost}:8000/api/delete`;
                
                console.log('发送删除请求到:', apiUrl);
                console.log('请求数据:', { fileId, password: '***' });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fileId: fileId,
                        password: password
                    })
                });
                
                console.log('删除响应状态:', response.status);
                console.log('删除响应头:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.log('删除失败，错误数据:', errorData);
                    throw new Error(errorData.error || '删除失败');
                }
                
                const result = await response.json();
                console.log('删除成功，结果:', result);
                
                if (!result.success) {
                    throw new Error(result.error || '删除失败');
                }
                
                showDeleteStatus(`文件 "${file.name}" 删除成功`, 'success');
                
                // 清空表单
                document.getElementById('deletePassword').value = '';
                document.getElementById('deleteFileSelect').value = '';
                
                // 刷新文件列表
                setTimeout(() => {
                    refreshFileList();
                    
                    // 关闭模态框
                    const modalElement = document.getElementById('manageModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('删除错误:', error);
                showDeleteStatus('删除失败: ' + error.message, 'danger');
            }
        }

        // 显示删除状态
        function showDeleteStatus(message, type) {
            const statusDiv = document.getElementById('deleteStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // 加载文件列表 - 从服务器获取
        async function loadFileList() {
            try {
                console.log('开始扫描文件...');
                
                // 从服务器获取文件列表
                const currentHost = window.location.hostname;
                const apiUrl = currentHost === 'localhost' || currentHost === '127.0.0.1' 
                    ? 'http://localhost:8000/api/files'
                    : `http://${currentHost}:8000/api/files`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const files = await response.json();
                console.log('从服务器获取的文件列表:', files);
                
                // 处理文件数据，添加下载URL
                allFiles = files.map(file => ({
                    ...file,
                    downloadUrl: `../knowledgehub/${file.path}/${file.name}`
                }));
                
                filteredFiles = [...allFiles];
                displayFiles();
                
                // 更新目录选项
                updateDirectoryOptions();
                
                console.log('文件列表加载完成，共', allFiles.length, '个文件');
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('noFilesMessage').style.display = 'block';
            }
        }

        // 显示文件列表
        function displayFiles() {
            const fileList = document.getElementById('fileList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noFilesMessage = document.getElementById('noFilesMessage');

            loadingIndicator.style.display = 'none';

            if (filteredFiles.length === 0) {
                noFilesMessage.style.display = 'block';
                fileList.innerHTML = '';
                return;
            }

            noFilesMessage.style.display = 'none';

            // 按文件夹分组，并按上传时间倒序排列
            const filesByFolder = groupFilesByFolder(filteredFiles);
            
            let html = '';
            for (const [folder, files] of Object.entries(filesByFolder)) {
                html += `
                    <div class="folder-section" id="folder-${folder}">
                        <div class="folder-header" onclick="toggleFolder('${folder}')" style="cursor: pointer;">
                            <div class="d-flex align-items-center justify-content-between">
                                <h4 class="mb-0">
                                    <i class="bi bi-folder me-2"></i>${folder}
                                    <span class="badge bg-primary ms-2">${files.length}</span>
                                </h4>
                                <i class="bi bi-chevron-down folder-toggle" id="toggle-${folder}"></i>
                            </div>
                        </div>
                        <div class="folder-content" id="content-${folder}">
                            <div class="row g-3">
                                ${files.map(file => createFileItem(file)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            fileList.innerHTML = html;
            
            // 更新左侧导航
            updateFolderNavigation();
        }

        // 更新左侧文件夹导航
        function updateFolderNavigation() {
            const folderNav = document.getElementById('folderNav');
            const filesByFolder = groupFilesByFolder(filteredFiles);
            
            let navHtml = '';
            for (const [folder, files] of Object.entries(filesByFolder)) {
                navHtml += `
                    <div class="list-group-item d-flex align-items-center" onclick="scrollToFolder('${folder}')">
                        <i class="bi bi-folder me-2"></i>
                        <span class="folder-name">${folder}</span>
                        <span class="folder-count">${files.length}</span>
                    </div>
                `;
            }
            
            folderNav.innerHTML = navHtml;
        }

        // 滚动到指定文件夹
        function scrollToFolder(folder) {
            const folderElement = document.getElementById(`folder-${folder}`);
            if (folderElement) {
                // 平滑滚动到文件夹位置
                folderElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                // 高亮显示目标文件夹
                highlightFolder(folder);
            }
        }

        // 高亮显示文件夹
        function highlightFolder(folder) {
            // 移除所有活动状态
            document.querySelectorAll('#folderNav .list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 添加活动状态到目标文件夹
            const navItem = document.querySelector(`#folderNav .list-group-item[onclick*="${folder}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
        }

        // 切换文件夹展开/折叠
        function toggleFolder(folder) {
            const content = document.getElementById(`content-${folder}`);
            const toggle = document.getElementById(`toggle-${folder}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.className = 'bi bi-chevron-down folder-toggle';
            } else {
                content.style.display = 'none';
                toggle.className = 'bi bi-chevron-right folder-toggle';
            }
        }

        // 按文件夹分组文件
        function groupFilesByFolder(files) {
            const groups = {};
            files.forEach(file => {
                const folder = file.path.split('/')[0] || '根目录';
                if (!groups[folder]) {
                    groups[folder] = [];
                }
                groups[folder].push(file);
            });
            
            // 对每个文件夹内的文件按上传时间倒序排列（最新的在前）
            Object.keys(groups).forEach(folder => {
                groups[folder].sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
            });
            
            // 按文件夹名称倒序排列（最新的年份月份在前）
            const sortedGroups = {};
            Object.keys(groups)
                .sort((a, b) => {
                    // 如果是根目录，排在最后
                    if (a === '根目录') return 1;
                    if (b === '根目录') return -1;
                    // 其他按名称倒序排列
                    return b.localeCompare(a);
                })
                .forEach(folder => {
                    sortedGroups[folder] = groups[folder];
                });
            
            return sortedGroups;
        }

        // 创建文件项HTML
        function createFileItem(file) {
            const fileIcon = getFileIcon(file.name);
            const fileSize = formatFileSize(file.size);
            const uploadTime = new Date(file.uploadTime).toLocaleString('zh-CN');
            
            return `
                <div class="col-12">
                    <div class="file-item">
                        <div class="row align-items-center g-0">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center">
                                    <div class="file-icon me-3 flex-shrink-0">
                                        <i class="bi ${fileIcon}"></i>
                                    </div>
                                    <div class="flex-grow-1 min-w-0">
                                        <h6 class="mb-1 text-truncate" title="${file.name}">${file.name}</h6>
                                        <div class="d-flex align-items-center text-muted small">
                                            <span class="me-3"><i class="bi bi-hdd me-1"></i>${fileSize}</span>
                                            <span><i class="bi bi-clock me-1"></i>${uploadTime}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="file-actions">
                                    <button class="btn btn-sm btn-primary btn-icon" onclick="downloadFile('${file.id}')" title="下载">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary btn-icon" onclick="copyDownloadLink('${file.downloadUrl}', this)" title="复制下载链接">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 获取文件图标
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const iconMap = {
                // 文档类型
                'pdf': 'bi-file-earmark-pdf',
                'doc': 'bi-file-earmark-word',
                'docx': 'bi-file-earmark-word',
                'ppt': 'bi-file-earmark-ppt',
                'pptx': 'bi-file-earmark-ppt',
                'xls': 'bi-file-earmark-excel',
                'xlsx': 'bi-file-earmark-excel',
                'txt': 'bi-file-earmark-text',
                'rtf': 'bi-file-earmark-text',
                'md': 'bi-file-earmark-text',
                
                // 图片类型
                'jpg': 'bi-file-earmark-image',
                'jpeg': 'bi-file-earmark-image',
                'png': 'bi-file-earmark-image',
                'gif': 'bi-file-earmark-image',
                'bmp': 'bi-file-earmark-image',
                'svg': 'bi-file-earmark-image',
                'webp': 'bi-file-earmark-image',
                'tiff': 'bi-file-earmark-image',
                
                // 视频类型
                'mp4': 'bi-file-earmark-play',
                'avi': 'bi-file-earmark-play',
                'mov': 'bi-file-earmark-play',
                'wmv': 'bi-file-earmark-play',
                'flv': 'bi-file-earmark-play',
                'mkv': 'bi-file-earmark-play',
                'webm': 'bi-file-earmark-play',
                
                // 音频类型
                'mp3': 'bi-file-earmark-music',
                'wav': 'bi-file-earmark-music',
                'flac': 'bi-file-earmark-music',
                'aac': 'bi-file-earmark-music',
                'ogg': 'bi-file-earmark-music',
                
                // 压缩文件
                'zip': 'bi-file-earmark-zip',
                'rar': 'bi-file-earmark-zip',
                '7z': 'bi-file-earmark-zip',
                'tar': 'bi-file-earmark-zip',
                'gz': 'bi-file-earmark-zip',
                
                // 代码文件
                'html': 'bi-file-earmark-code',
                'css': 'bi-file-earmark-code',
                'js': 'bi-file-earmark-code',
                'json': 'bi-file-earmark-code',
                'xml': 'bi-file-earmark-code',
                'py': 'bi-file-earmark-code',
                'java': 'bi-file-earmark-code',
                'cpp': 'bi-file-earmark-code',
                'c': 'bi-file-earmark-code',
                'php': 'bi-file-earmark-code',
                'sql': 'bi-file-earmark-code',
                'sh': 'bi-file-earmark-code',
                'bat': 'bi-file-earmark-code',
                
                // 3D文件
                'stl': 'bi-file-earmark-3d',
                'obj': 'bi-file-earmark-3d',
                'fbx': 'bi-file-earmark-3d',
                'dae': 'bi-file-earmark-3d',
                
                // 其他常见格式
                'csv': 'bi-file-earmark-spreadsheet',
                'tsv': 'bi-file-earmark-spreadsheet',
                'log': 'bi-file-earmark-text',
                'ini': 'bi-file-earmark-text',
                'cfg': 'bi-file-earmark-text',
                'conf': 'bi-file-earmark-text'
            };
            return iconMap[ext] || 'bi-file-earmark';
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 过滤文件
        function filterFiles(searchTerm) {
            if (!searchTerm.trim()) {
                filteredFiles = [...allFiles];
            } else {
                filteredFiles = allFiles.filter(file => 
                    file.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            displayFiles();
        }

        // 下载文件
        async function downloadFile(fileId) {
            try {
                const file = allFiles.find(f => f.id === fileId);
                if (!file) {
                    throw new Error('File not found');
                }
                
                // 直接创建下载链接，服务器已设置正确的响应头
                const a = document.createElement('a');
                a.href = file.downloadUrl;
                a.download = file.name;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                console.log('开始下载文件:', file.name);
            } catch (error) {
                console.error('Download error:', error);
                alert('下载失败，请稍后重试或联系管理员');
            }
        }

        // 复制下载链接
        async function copyDownloadLink(url, button) {
            try {
                // 构建完整的下载URL，添加download参数确保直接下载
                const fullUrl = window.location.origin + '/' + url.replace('../', '') + '?download=true';
                
                // 尝试使用现代API
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(fullUrl);
                } else {
                    // 降级方案：使用传统方法
                    const textArea = document.createElement('textarea');
                    textArea.value = fullUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                
                // 显示成功状态
                const originalClass = button.className;
                const originalHTML = button.innerHTML;
                
                button.className = 'btn btn-sm btn-success btn-icon';
                button.innerHTML = '<i class="bi bi-check"></i>';
                button.title = '已复制';
                
                setTimeout(() => {
                    button.className = originalClass;
                    button.innerHTML = originalHTML;
                    button.title = '复制下载链接';
                }, 2000);
                
                console.log('已复制下载链接:', fullUrl);
            } catch (error) {
                console.error('Copy error:', error);
                // 如果复制失败，显示链接让用户手动复制
                const fullUrl = window.location.origin + '/' + url.replace('../', '') + '?download=true';
                alert(`复制失败，请手动复制以下链接：\n\n${fullUrl}`);
            }
        }
    </script>
</body>
</html> 